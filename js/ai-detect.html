<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ƒê·∫øm ng∆∞·ªùi trong video - COCO-SSD (TF.js)</title>
  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      margin: 0;
      background: #0f172a;
      color: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      overflow: hidden;
    }

    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: #000;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      height: 100%;
      width: auto;
      object-fit: contain;
      display: block;
    }

    canvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
      height: 100%;
      width: auto;
    }

    #controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(15, 23, 42, 0.6);
      backdrop-filter: blur(8px);
      padding: 10px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
      transition: opacity 0.3s ease;
    }

    button, .file-label {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border: none;
      color: white;
      font-size: 15px;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.25s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    button:hover, .file-label:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.4);
    }

    /* ·∫®n input file */
    #videoFile {
      display: none;
    }

    .file-label::before {
      content: "üìÅ";
      font-size: 17px;
    }

    #count {
      font-weight: bold;
      color: #22c55e;
      font-size: 18px;
    }

    /* Khi ·∫©n n√∫t */
    .hidden-buttons button,
    .hidden-buttons .file-label {
      display: none;
    }
  </style>
</head>
<body>
  <div id="container">
    <video id="video" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>

    <div id="controls">
      <button id="startWebcam">üé• B·∫≠t Webcam</button>
      <label for="videoFile" class="file-label">Ch·ªçn video</label>
      <input id="videoFile" type="file" accept="video/*" />
      <span>üë• <strong id="count">0</strong> ng∆∞·ªùi</span>
    </div>
  </div>

  <!-- TensorFlow.js v√† COCO-SSD -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.8.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('overlay');
    const ctx = canvas.getContext('2d');
    const countEl = document.getElementById('count');
    const controls = document.getElementById('controls');

    let model = null;
    let detecting = false;
    let detectInterval = null;

    const COLORS = [
      '#FF6B6B', '#4ECDC4', '#FFE66D', '#1A535C',
      '#FF9F1C', '#2EC4B6', '#EF476F', '#7209B7',
      '#06D6A0', '#118AB2', '#F15BB5', '#3A86FF'
    ];

    async function loadModel() {
      model = await cocoSsd.load();
      console.log('‚úÖ Model COCO-SSD loaded');
    }

    async function startWebcam() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        stopVideoIfNeeded();
        video.srcObject = stream;
        await video.play();
        setupCanvas();
        hideButtons();
        startDetectLoop();
      } catch (err) {
        alert('Kh√¥ng th·ªÉ m·ªü webcam: ' + err.message);
      }
    }

    function setupCanvas() {
      // ƒê·ªìng b·ªô k√≠ch th∆∞·ªõc canvas v·ªõi video th·∫≠t
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }

    function stopVideoIfNeeded() {
      if (video.srcObject) {
        const tracks = video.srcObject.getTracks();
        tracks.forEach(t => t.stop());
        video.srcObject = null;
      }
    }

    function hideButtons() {
      controls.classList.add('hidden-buttons');
    }

    document.getElementById('startWebcam').addEventListener('click', startWebcam);

    document.getElementById('videoFile').addEventListener('change', async (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      stopVideoIfNeeded();
      video.src = URL.createObjectURL(file);
      await video.play();
      setupCanvas();
      hideButtons();
      startDetectLoop();
    });

    function startDetectLoop() {
      if (!model) {
        console.warn('‚è≥ ƒêang load model...');
        return;
      }
      if (detecting) return;
      detecting = true;
      if (detectInterval) clearInterval(detectInterval);
      detectInterval = setInterval(detectFrame, 200);
    }

    async function detectFrame() {
      if (!detecting || video.readyState < 2) return;

      const predictions = await model.detect(video);
      const persons = predictions.filter(p => p.class === 'person' && p.score > 0.2);

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 3;
      ctx.font = 'bold 18px Segoe UI';

      persons.forEach((pred, idx) => {
        const [x, y, w, h] = pred.bbox;
        const color = COLORS[idx % COLORS.length];
        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.strokeRect(x, y, w, h);

        const label = `#${idx + 1}`;
        const padding = 6;
        const labelY = Math.max(24, y - 10);
        const textWidth = ctx.measureText(label).width;
        const boxW = textWidth + padding * 2;
        const boxH = 24;

        ctx.fillStyle = hexToRgba(color, 0.8);
        roundRect(ctx, x, labelY - boxH, boxW, boxH, 6);
        ctx.fill();

        ctx.fillStyle = '#fff';
        ctx.fillText(label, x + padding, labelY - 6);
      });

      countEl.textContent = persons.length;
    }

    function roundRect(ctx, x, y, width, height, radius) {
      ctx.beginPath();
      ctx.moveTo(x + radius, y);
      ctx.lineTo(x + width - radius, y);
      ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
      ctx.lineTo(x + width, y + height - radius);
      ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
      ctx.lineTo(x + radius, y + height);
      ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
      ctx.lineTo(x, y + radius);
      ctx.quadraticCurveTo(x, y, x + radius, y);
      ctx.closePath();
    }

    function hexToRgba(hex, alpha = 1) {
      const bigint = parseInt(hex.slice(1), 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `rgba(${r},${g},${b},${alpha})`;
    }

    window.addEventListener('beforeunload', () => {
      if (detectInterval) clearInterval(detectInterval);
      stopVideoIfNeeded();
    });

    loadModel();
  </script>
</body>
</html>